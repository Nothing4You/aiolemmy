name: CI/CD

on:
  push:
    branches-ignore:
      - dependabot/**
  pull_request:
  workflow_dispatch:
    inputs:
      release-version:
        # github.event_name == 'workflow_dispatch'
        # && github.event.inputs.release-version
        description: >-
          Target PEP440-compliant version to release.
          Please, don't prepend `v`.
        required: true
      release-commitish:
        # github.event_name == 'workflow_dispatch'
        # && github.event.inputs.release-commitish
        default: ""
        description: >-
          The commit to be released to PyPI and tagged
          in Git as `release-version`. Normally, you
          should keep this empty.
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  pre-setup:
    name: âš™ï¸ Pre-set global build settings
    runs-on: ubuntu-latest
    outputs:
      dists-artifact-name: python-package-distributions
      dist-version: >-
        ${{
            steps.request-check.outputs.release-requested == 'true'
            && github.event.inputs.release-version
            || steps.scm-version.outputs.dist-version
        }}
      is-untagged-devel: >-
        ${{ steps.untagged-check.outputs.is-untagged-devel || false }}
      release-requested: >-
        ${{
            steps.request-check.outputs.release-requested || false
        }}
      git-tag: ${{ steps.git-tag.outputs.tag }}
      sdist-artifact-name: ${{ steps.artifact-name.outputs.sdist }}
      wheel-artifact-name: ${{ steps.artifact-name.outputs.wheel }}

    steps:
      - name: >-
          Mark the build as untagged '${{
              github.event.repository.default_branch
          }}' branch build
        id: untagged-check
        if: >-
          github.event_name == 'push' &&
          github.ref == format(
            'refs/heads/{0}', github.event.repository.default_branch
          )
        run: >-
          echo "is-untagged-devel=true" >> "$GITHUB_OUTPUT"
      - name: Mark the build as "release request"
        id: request-check
        if: github.event_name == 'workflow_dispatch'
        run: >-
          echo "release-requested=true" >> "$GITHUB_OUTPUT"

      - name: Check out src from Git
        if: >-
          steps.request-check.outputs.release-requested != 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.release-commitish }}

      - name: Drop Git tags from HEAD for non-release requests
        if: >-
          steps.request-check.outputs.release-requested != 'true'
        run: >-
          git tag --points-at HEAD
          |
          xargs git tag --delete

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version-file: .python-version

      - name: Install uv
        uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a # v7.1.5
        with:
          enable-cache: true
          version: 0.9.16 # renovate: uv

      # TODO: migrate this to native uv once supported
      - name: Set the current dist version from Git
        if: steps.request-check.outputs.release-requested != 'true'
        id: scm-version
        run: >-
          echo "dist-version=$(
          uvx pdm show --version
          ${{
            steps.untagged-check.outputs.is-untagged-devel == 'true'
            && '| cut -d+ -f1' ||''
          }}
          )" >> "$GITHUB_OUTPUT"
        env:
          PDM_USE_UV: "true"

      - name: Set the target Git tag
        id: git-tag
        run: >-
          echo "tag=v${{
              steps.request-check.outputs.release-requested == 'true'
              && github.event.inputs.release-version
              || steps.scm-version.outputs.dist-version
          }}" >> "$GITHUB_OUTPUT"

      - name: Set the expected dist artifact names
        id: artifact-name
        run: |
          echo "sdist=aiolemmy-${{
              steps.request-check.outputs.release-requested == 'true'
              && github.event.inputs.release-version
              || steps.scm-version.outputs.dist-version
          }}.tar.gz" >> "$GITHUB_OUTPUT"
          echo "wheel=aiolemmy-${{
              steps.request-check.outputs.release-requested == 'true'
              && github.event.inputs.release-version
              || steps.scm-version.outputs.dist-version
          }}-py3-none-any.whl" >> "$GITHUB_OUTPUT"

  build:
    name: >-
      ðŸ‘· dists ${{ needs.pre-setup.outputs.git-tag }}
      [mode: ${{
        fromJSON(needs.pre-setup.outputs.is-untagged-devel)
        && 'nightly' || ''
      }}${{
        fromJSON(needs.pre-setup.outputs.release-requested)
        && 'release' || ''
      }}${{
        (
          !fromJSON(needs.pre-setup.outputs.is-untagged-devel)
          && !fromJSON(needs.pre-setup.outputs.release-requested)
        ) && 'test' || ''
      }}]
    needs:
      - pre-setup # transitive, for accessing settings

    runs-on: ubuntu-latest

    env:
      PY_COLORS: 1

    steps:
      - name: Grab the source from Git
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: >-
            ${{
                steps.request-check.outputs.release-requested == 'true'
                && 1 || 0
            }}
          ref: ${{ github.event.inputs.release-commitish }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version-file: .python-version

      - name: Install uv
        uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a # v7.1.5
        with:
          enable-cache: true
          version: 0.9.16 # renovate: uv

      - name: Setup git user as [bot]
        if: >-
          fromJSON(needs.pre-setup.outputs.is-untagged-devel)
          || fromJSON(needs.pre-setup.outputs.release-requested)
        uses: fregante/setup-git-user@024bc0b8e177d7e77203b48dab6fb45666854b35

      - name: >-
          Tag the release in the local Git repo
          as ${{ needs.pre-setup.outputs.git-tag }}
          for setuptools-scm to set the desired version
        if: >-
          fromJSON(needs.pre-setup.outputs.is-untagged-devel)
          || fromJSON(needs.pre-setup.outputs.release-requested)
        run: >-
          git tag
          -m '${{ needs.pre-setup.outputs.git-tag }}'
          '${{ needs.pre-setup.outputs.git-tag }}'
          --
          ${{ github.event.inputs.release-commitish }}

      - name: Build dists
        run: >-
          uv build

      - name: Verify that the artifacts with expected names got created
        run: >-
          ls -1
          'dist/${{ needs.pre-setup.outputs.sdist-artifact-name }}'
          'dist/${{ needs.pre-setup.outputs.wheel-artifact-name }}'
      - name: Store the distribution packages
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: >-
            ${{ needs.pre-setup.outputs.dists-artifact-name }}
          # NOTE: Exact expected file names are specified here
          # NOTE: as a safety measure â€” if anything weird ends
          # NOTE: up being in this dir or not all dists will be
          # NOTE: produced, this will fail the workflow.
          path: |
            dist/${{ needs.pre-setup.outputs.sdist-artifact-name }}
            dist/${{ needs.pre-setup.outputs.wheel-artifact-name }}
          retention-days: 30

  lint:
    name: ðŸ§¹ Lint

    needs:
      - build
      - pre-setup # transitive, for accessing settings

    runs-on: ubuntu-latest

    env:
      PY_COLORS: 1

    steps:
      - name: Grab the source from Git
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.inputs.release-commitish }}

      - name: Download all the dists
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: ${{ needs.pre-setup.outputs.dists-artifact-name }}
          path: dist/

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version-file: .python-version

      - name: Install uv
        uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a # v7.1.5
        with:
          enable-cache: true
          version: 0.9.16 # renovate: uv

      - name: Check package description
        run: >-
          uv run twine check --strict dist/*

  check: # This job does nothing and is only used for the branch protection
    if: always()

    needs:
      - lint

    runs-on: ubuntu-latest

    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
        with:
          jobs: ${{ toJSON(needs) }}

  publish-pypi:
    name: Publish ðŸðŸ“¦ ${{ needs.pre-setup.outputs.git-tag }} to PyPI
    needs:
      - check
      - pre-setup # transitive, for accessing settings
    if: >-
      fromJSON(needs.pre-setup.outputs.release-requested)
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: >-
        https://pypi.org/project/aiolemmy/${{
          needs.pre-setup.outputs.dist-version
        }}

    permissions:
      id-token: write # this permission is mandatory for trusted publishing

    steps:
      - name: Download all the dists
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: ${{ needs.pre-setup.outputs.dists-artifact-name }}
          path: dist/
      - name: >-
          Publish ðŸðŸ“¦ ${{ needs.pre-setup.outputs.git-tag }} to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          print-hash: true

  publish-testpypi:
    name: Publish ðŸðŸ“¦ ${{ needs.pre-setup.outputs.git-tag }} to TestPyPI
    needs:
      - check
      - pre-setup # transitive, for accessing settings
    if: >-
      fromJSON(needs.pre-setup.outputs.is-untagged-devel)
      || fromJSON(needs.pre-setup.outputs.release-requested)
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      url: >-
        https://test.pypi.org/project/aiolemmy/${{
          needs.pre-setup.outputs.dist-version
        }}

    permissions:
      id-token: write # this permission is mandatory for trusted publishing

    steps:
      - name: Download all the dists
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: ${{ needs.pre-setup.outputs.dists-artifact-name }}
          path: dist/
      - name: >-
          Publish ðŸðŸ“¦ ${{ needs.pre-setup.outputs.git-tag }} to TestPyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          repository-url: https://test.pypi.org/legacy/
          print-hash: true

  post-release-repo-update:
    name: >-
      Publish post-release Git tag
      for ${{ needs.pre-setup.outputs.git-tag }}
    needs:
      - publish-pypi
      - pre-setup # transitive, for accessing settings
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Fetch the src snapshot
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          ref: ${{ github.event.inputs.release-commitish }}

      - name: Setup git user as [bot]
        uses: fregante/setup-git-user@024bc0b8e177d7e77203b48dab6fb45666854b35 # v2.0.2

      - name: >-
          Tag the release in the local Git repo
          as v${{ needs.pre-setup.outputs.git-tag }}
        run: >-
          git tag
          -m '${{ needs.pre-setup.outputs.git-tag }}'
          '${{ needs.pre-setup.outputs.git-tag }}'
          --
          ${{ github.event.inputs.release-commitish }}

      - name: >-
          Push ${{ needs.pre-setup.outputs.git-tag }} tag corresponding
          to the just published release back to GitHub
        run: >-
          git push --atomic origin '${{ needs.pre-setup.outputs.git-tag }}'

  publish-github-release:
    name: >-
      Publish a tag and GitHub release for
      ${{ needs.pre-setup.outputs.git-tag }}
    needs:
      - post-release-repo-update
      - pre-setup # transitive, for accessing settings
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Fetch the src snapshot
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          ref: ${{ github.event.inputs.release-commitish }}

      - name: Download all the dists
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: ${{ needs.pre-setup.outputs.dists-artifact-name }}
          path: dist/

      - name: >-
          Publish a GitHub Release for
          ${{ needs.pre-setup.outputs.git-tag }}
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          artifacts: |
            dist/${{ needs.pre-setup.outputs.sdist-artifact-name }}
            dist/${{ needs.pre-setup.outputs.wheel-artifact-name }}
          artifactContentType: raw # Because whl and tgz are of different types
          name: ${{ needs.pre-setup.outputs.git-tag }}
          tag: ${{ needs.pre-setup.outputs.git-tag }}
